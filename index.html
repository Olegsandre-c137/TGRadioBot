<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Dynamic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* –ö–ª–∞—Å—Ç–µ—Ä (–°–∏–Ω—è—è –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å) */
        .cluster-marker {
            width: 30px; height: 30px; border: 2px solid #007bff; border-radius: 50%;
            background: rgba(0, 123, 255, 0.2); display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold; color: white;
            cursor: pointer; pointer-events: auto; transform: translate(-50%, -50%);
        }

        /* –û–¥–∏–Ω–æ—á–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è (–ó–µ–ª–µ–Ω—ã–π –∫—Ä—É–≥) */
        .station-dot {
            width: 8px; height: 8px; background: #00ff88; border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.5); cursor: pointer; transform: translate(-50%, -50%);
        }
        .station-dot.active { background: #ffa500; width: 10px; height: 10px; }

        #status-bar { position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 12px; text-align: center; border-bottom: 1px solid #333; z-index: 1005; display: none; }
        #status-station { font-size: 14px; font-weight: bold; color: #ffa500; }
        
        #controls { position: fixed; top: 60px; width: 100%; display: flex; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 1001; pointer-events: none; }
        .btn { background: #222; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; pointer-events: auto; color: white; font-size: 20px; }

        #side-drawer { position: fixed; top: 0; left: -280px; width: 260px; height: 100%; background: #0d0d0d; z-index: 1002; transition: 0.3s ease; display: flex; flex-direction: column; border-right: 1px solid #333; }
        #side-drawer.open { left: 0; }
        #stations-list { flex: 1; overflow-y: auto; padding: 10px; }
        .station-item { padding: 12px; border-bottom: 1px solid #222; font-size: 13px; color: #ccc; cursor: pointer; }

        #player-container { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 85%; background: #111; padding: 15px; border-radius: 20px; z-index: 1100; border: 1px solid #333; display: none; }
    </style>
</head>
<body>

    <div id="status-bar"><div id="status-station">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    <div id="controls">
        <div class="btn" onclick="document.getElementById('side-drawer').classList.toggle('open')">‚ò∞</div>
        <div class="btn" onclick="findUserLocation()">üìç</div>
    </div>
    <div id="globeViz"></div>
    <div id="side-drawer">
        <div style="padding:20px; margin-top:40px; font-weight:bold; border-bottom:1px solid #333;">–°—Ç–∞–Ω—Ü–∏–∏ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ</div>
        <div id="stations-list"></div>
    </div>
    <div id="player-container">
        <div style="display:flex; align-items:center; gap:12px;">
            <span>üîà</span>
            <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.8" style="flex:1; accent-color:#ffa500;">
            <span id="time-display" style="font-size:12px; font-family:monospace; color:#888;">00:00</span>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        let allData = [];
        let activeUrl = null;
        const audioPlayer = document.getElementById('audio-player');

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                if (d.count > 1) {
                    // –†–∏—Å—É–µ–º –ö–õ–ê–°–¢–ï–†
                    el.className = 'cluster-marker';
                    el.innerHTML = d.count;
                    el.onclick = () => {
                        const newAlt = world.pointOfView().alt * 0.5;
                        world.pointOfView({ lat: d.lat, lng: d.lng, alt: newAlt }, 1000);
                        setTimeout(loadRegionalStations, 1100);
                    };
                } else {
                    // –†–∏—Å—É–µ–º –¢–û–ß–ö–£
                    el.className = 'station-dot';
                    if (activeUrl === d.url) el.classList.add('active');
                    el.onclick = () => loadFullCityList(d);
                }
                return el;
            });

        // 1. –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¢–û–ü —Å—Ç–∞–Ω—Ü–∏–π
        fetch('https://de1.api.radio-browser.info/json/stations/search?limit=400&has_geo_info=true&hidebroken=true&order=clickcount&reverse=true')
            .then(res => res.json())
            .then(data => {
                allData = data;
                clusterize(data);
            });

        // –§—É–Ω–∫—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ (–≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ç–æ—á–∫–∏ –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏)
        function clusterize(stations) {
            const clusters = [];
            const gridSize = world.pointOfView().alt * 10; // –†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã –∫–∞–º–µ—Ä—ã

            const map = {};
            stations.forEach(s => {
                const latIdx = Math.round(s.geo_lat / gridSize) * gridSize;
                const lngIdx = Math.round(s.geo_long / gridSize) * gridSize;
                const key = `${latIdx},${lngIdx}`;
                
                if (!map[key]) {
                    map[key] = { lat: latIdx, lng: lngIdx, count: 0, url: s.url_resolved, name: s.name, city: s.state || s.country };
                }
                map[key].count++;
            });
            world.htmlElementsData(Object.values(map));
        }

        // 2. –ü–æ–¥–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ (–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫)
        function loadRegionalStations() {
            const { lat, lng, alt } = world.pointOfView();
            if (alt > 0.8) return; // –ù–µ –≥—Ä—É–∑–∏–º –Ω–∞ –±–æ–ª—å—à–æ–π –≤—ã—Å–æ—Ç–µ

            const radius = alt * 20; 
            fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=200&hidebroken=true`)
                .then(res => res.json())
                .then(data => {
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, —É–±–∏—Ä–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã
                    const combined = [...allData, ...data];
                    allData = Array.from(new Set(combined.map(a => a.stationuuid))).map(id => combined.find(a => a.stationuuid === id));
                    clusterize(allData);
                });
        }

        // 3. –ü–æ–¥–≥—Ä—É–∑–∫–∞ –í–°–ï–ì–û —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ç–æ—á–∫—É
        function loadFullCityList(d) {
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: 0.4 }, 600);
            
            // –ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –≤ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–º —Ä–∞–¥–∏—É—Å–µ (–≤–µ—Å—å –≥–æ—Ä–æ–¥)
            fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${d.lat}&lon=${d.lng}&radius=0.5&limit=500&hidebroken=true`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('stations-list');
                    list.innerHTML = '';
                    data.sort((a,b) => b.clickcount - a.clickcount).forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'station-item';
                        item.innerText = s.name;
                        item.onclick = () => play(s);
                        list.appendChild(item);
                    });
                    document.getElementById('side-drawer').classList.add('open');
                });
        }

        function play(s) {
            activeUrl = s.url_resolved;
            document.getElementById('status-bar').style.display = 'block';
            document.getElementById('status-station').innerText = s.name;
            audioPlayer.src = s.url_resolved.replace('http://', 'https://');
            document.getElementById('player-container').style.display = 'block';
            audioPlayer.play();
            clusterize(allData); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç
        }

        // –°–ª–µ–¥–∏–º –∑–∞ –∑—É–º–æ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ã
        world.controls().addEventListener('change', () => {
            clusterize(allData);
        });

        function findUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude: lat, longitude: lng } = pos.coords;
                    world.pointOfView({ lat, lng, alt: 0.5 }, 1200);
                    setTimeout(loadRegionalStations, 1300);
                });
            }
        }

        document.getElementById('volume-control').oninput = (e) => audioPlayer.volume = e.target.value;
        audioPlayer.ontimeupdate = () => {
            const m = Math.floor(audioPlayer.currentTime / 60);
            const s = Math.floor(audioPlayer.currentTime % 60);
            document.getElementById('time-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));
    </script>
</body>
</html>
