<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe TMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        #globeViz { width: 100vw; height: 100vh; touch-action: none; }
        
        #player-card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(20, 20, 20, 0.9); padding: 15px;
            border-radius: 20px; backdrop-filter: blur(10px);
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        #station-name { font-weight: bold; margin-bottom: 10px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        audio { width: 100%; height: 35px; }
    </style>
</head>
<body>

    <div id="globeViz"></div>

    <div id="player-card">
        <div id="station-name">Выберите станцию</div>
        <audio id="audio-player" controls></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Развернуть на весь экран
        tg.disableVerticalSwipes(); // Чтобы глобус не закрывал приложение при свайпе вниз

        const playerCard = document.getElementById('player-card');
        const audioPlayer = document.getElementById('audio-player');
        const stationName = document.getElementById('station-name');

        // Инициализация глобуса
        const world = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .pointColor(() => '#00ff88')
            .pointRadius(0.6)
            .pointAltitude(0.01)
            .onPointClick(point => {
                playStation(point);
            });

        // Загрузка популярных станций (500 штук для скорости)
        fetch('https://at1.api.radio-browser.info/json/stations/topclick/500')
            .then(res => res.json())
            .then(stations => {
                const gData = stations
                    .filter(s => s.geo_lat && s.geo_long)
                    .map(s => ({
                        lat: s.geo_lat,
                        lng: s.geo_long,
                        name: s.name,
                        url: s.url_resolved
                    }));
                world.pointsData(gData);
            });

        function playStation(station) {
            // Тактильная отдача
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            stationName.innerText = station.name;
            audioPlayer.src = station.url;
            playerCard.style.display = 'block';
            audioPlayer.play();
        }

        // Подстройка под тему Telegram (опционально)
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#000';
    </script>
</body>
</html>
