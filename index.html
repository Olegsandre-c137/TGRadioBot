<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Garden Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* –°—Ç–∏–ª–∏ –≥–ª–æ–±—É—Å–∞ –∏ –º–µ—Ç–æ–∫ */
        .cluster-marker {
            width: 35px; height: 35px; border: 2px solid #007bff; border-radius: 50%;
            background: rgba(0, 123, 255, 0.4); display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold; color: white;
            cursor: pointer; pointer-events: auto; transform: translate(-50%, -50%);
        }
        .station-dot {
            width: 10px; height: 10px; background: #00ff88; border-radius: 50%;
            border: 2px solid #000; cursor: pointer; pointer-events: auto; transform: translate(-50%, -50%);
        }
        .station-dot.active { background: #ffa500; box-shadow: 0 0 10px #ffa500; }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #header {
            position: fixed; top: 0; width: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 15px; text-align: center; z-index: 10; pointer-events: none;
        }
        #current-city { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #aaa; }
        #current-station { font-size: 16px; font-weight: bold; color: #ffa500; }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .icon-btn {
            position: fixed; z-index: 20; background: rgba(30,30,30,0.9);
            border: 1px solid #444; border-radius: 12px; width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: white;
        }
        #menu-toggle { top: 15px; left: 15px; }
        #geo-btn { top: 15px; right: 15px; font-size: 20px; }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
        #side-menu {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(10,10,10,0.98); z-index: 30; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        #side-menu.open { left: 0; }
        .search-container { padding: 60px 15px 15px; }
        #search-input {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #444;
            background: #111; color: white; outline: none; box-sizing: border-box;
        }
        #stations-list { flex: 1; overflow-y: auto; padding: 0 15px 100px; }
        .city-header { color: #00ff88; font-size: 12px; padding: 15px 0 5px; border-bottom: 1px solid #222; }
        .station-item { padding: 12px 0; border-bottom: 1px solid #1a1a1a; cursor: pointer; font-size: 14px; color: #ccc; }
        .station-item:active { color: #ffa500; }

        /* –ù–∏–∂–Ω–∏–π –ø–ª–µ–µ—Ä */
        #player-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(20,20,20,0.95);
            border: 1px solid #333; border-radius: 20px; padding: 15px;
            display: flex; align-items: center; gap: 15px; z-index: 40; backdrop-filter: blur(10px);
        }
        #volume-slider { flex: 1; accent-color: #ffa500; height: 4px; }
        #timer { font-family: monospace; font-size: 12px; color: #888; min-width: 40px; }
    </style>
</head>
<body>

    <div id="header">
        <div id="current-city">–í–´–ë–ï–†–ò–¢–ï –°–¢–ê–ù–¶–ò–Æ</div>
        <div id="current-station">Radio Garden App</div>
    </div>

    <div id="menu-toggle" class="icon-btn" onclick="toggleMenu()">‚ûî</div>
    <div id="geo-btn" class="icon-btn" onclick="goToMyLocation()">üìç</div>

    <div id="side-menu">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ (–ú–æ—Å–∫–≤–∞, London...)">
        </div>
        <div id="stations-list"></div>
    </div>

    <div id="player-bar">
        <span>üîà</span>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.8">
        <div id="timer">00:00</div>
    </div>

    <div id="globeViz"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let allPlaces = [];
        let activePlaceId = null;
        const audio = new Audio();
        audio.crossOrigin = "anonymous";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±—É—Å–∞
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            .atmosphereAltitude(0.15)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                if (d.isCluster) {
                    el.className = 'cluster-marker';
                    el.innerHTML = d.count;
                    el.onclick = () => {
                        const current = world.pointOfView();
                        world.pointOfView({ lat: d.lat, lng: d.lng, alt: current.alt * 0.5 }, 1000);
                    };
                } else {
                    el.className = 'station-dot';
                    if (d.id === activePlaceId) el.classList.add('active');
                    el.onclick = () => selectPlace(d);
                }
                return el;
            });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¢–û–ü –º–µ—Å—Ç –∏–∑ Radio Garden
        async function loadInitialData() {
            try {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º Radio Garden API —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–µ—Å—Ç –æ–≥—Ä–æ–º–Ω—ã–π. 
                // –ú—ã –∏–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ –∏—Ö –ø—É–±–ª–∏—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –±–∞–∑—É.
                const response = await fetch('https://radio.garden/api/ara/content/places');
                const json = await response.json();
                allPlaces = json.data.list.map(p => ({
                    id: p.id,
                    lat: p.geo[1],
                    lng: p.geo[0],
                    city: p.title,
                    count: 1
                }));
                updateVisualization();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", e);
            }
        }

        function updateVisualization() {
            const { alt } = world.pointOfView();
            // –ü—Ä–æ—Å—Ç–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (—Å–µ—Ç–∫–∏)
            const gridSize = alt * 15;
            const clusters = {};

            allPlaces.forEach(p => {
                const latGrid = Math.round(p.lat / gridSize) * gridSize;
                const lngGrid = Math.round(p.lng / gridSize) * gridSize;
                const key = `${latGrid.toFixed(1)}_${lngGrid.toFixed(1)}`;

                if (!clusters[key]) {
                    clusters[key] = { lat: p.lat, lng: p.lng, count: 0, isCluster: false, id: p.id, city: p.city };
                }
                clusters[key].count++;
            });

            const data = Object.values(clusters).map(c => {
                if (c.count > 1 && alt > 0.7) c.isCluster = true;
                return c;
            });

            world.htmlElementsData(data);
        }

        async function selectPlace(place) {
            activePlaceId = place.id;
            world.pointOfView({ lat: place.lat, lng: place.lng, alt: 0.5 }, 800);
            updateVisualization();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞–Ω—Ü–∏–π –≥–æ—Ä–æ–¥–∞
            try {
                const res = await fetch(`https://radio.garden/api/ara/content/page/place/${place.id}`);
                const json = await res.json();
                const channels = json.data.content[0].items;

                const list = document.getElementById('stations-list');
                list.innerHTML = `<div class="city-header">${place.city.toUpperCase()}</div>`;
                
                channels.forEach(ch => {
                    const id = ch.href.split('/').pop();
                    const div = document.createElement('div');
                    div.className = 'station-item';
                    div.innerText = ch.title;
                    div.onclick = () => playStation(id, ch.title, place.city);
                    list.appendChild(div);
                });

                document.getElementById('side-menu').classList.add('open');
                document.getElementById('menu-toggle').style.transform = 'rotate(180deg)';
            } catch (e) { console.error(e); }
        }

        function playStation(id, title, city) {
            document.getElementById('current-city').innerText = city;
            document.getElementById('current-station').innerText = title;
            
            // URL –ø–æ—Ç–æ–∫–∞ Radio Garden
            audio.src = `https://radio.garden/api/ara/content/listen/${id}/channel.mp3`;
            audio.play();
            
            if (window.innerWidth < 600) toggleMenu(); // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
        }

        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            const btn = document.getElementById('menu-toggle');
            menu.classList.toggle('open');
            btn.style.transform = menu.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function goToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude: lat, longitude: lng } = pos.coords;
                    world.pointOfView({ lat, lng, alt: 0.5 }, 1200);
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ placeId –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                }, () => alert("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω"));
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
        world.controls().addEventListener('change', updateVisualization);

        document.getElementById('volume-slider').oninput = (e) => audio.volume = e.target.value;

        audio.ontimeupdate = () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        document.getElementById('search-input').oninput = (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allPlaces.filter(p => p.city.toLowerCase().includes(query)).slice(0, 20);
            const list = document.getElementById('stations-list');
            list.innerHTML = '<div class="city-header">–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê</div>';
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = 'station-item';
                div.innerText = p.city;
                div.onclick = () => selectPlace(p);
                list.appendChild(div);
            });
        };

        // –ó–∞–ø—É—Å–∫
        loadInitialData();

    </script>
</body>
</html>
