<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe TMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; 
        }
        #globeViz { width: 100vw; height: 100vh; touch-action: none; }
        
        #player-card {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(28, 28, 28, 0.9); padding: 16px;
            border-radius: 24px; backdrop-filter: blur(15px);
            display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); text-align: center;
            z-index: 10;
        }
        #station-name { 
            font-weight: 600; margin-bottom: 12px; font-size: 15px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        audio { width: 100%; height: 40px; border-radius: 8px; }

        /* –õ–æ–∞–¥–µ—Ä –ø–æ–∫–∞ –≥—Ä—É–∑—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 14px; opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω—Ü–∏–π...</div>
    <div id="globeViz"></div>

    <div id="player-card">
        <div id="station-name">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é</div>
        <audio id="audio-player" controls></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.disableVerticalSwipes();

        const playerCard = document.getElementById('player-card');
        const audioPlayer = document.getElementById('audio-player');
        const stationName = document.getElementById('station-name');
        const loader = document.getElementById('loader');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±—É—Å–∞
        const world = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .pointColor(() => '#00ff88') // –Ø—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π
            .pointRadius(0.7)
            .pointAltitude(0.02)
            .pointLabel('name') // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–º—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (–Ω–∞ –ü–ö)
            .onPointClick(point => {
                playStation(point);
            });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.5;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –Ω–µ–º–µ—Ü–∫–∏–π —Å–µ—Ä–≤–µ—Ä (de1)
        // –§–∏–ª—å—Ç—Ä—É–µ–º: —Ç–æ–ª—å–∫–æ HTTPS, —Ç–æ–ª—å–∫–æ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏, —Ç–æ–ª—å–∫–æ –∂–∏–≤—ã–µ (hidebroken)
        const api_url = 'https://de1.api.radio-browser.info/json/stations/search?limit=600&has_geo_info=true&hidebroken=true&https=true&order=clickcount&reverse=true';

        fetch(api_url)
            .then(res => res.json())
            .then(stations => {
                loader.style.display = 'none';
                const gData = stations.map(s => ({
                    lat: parseFloat(s.geo_lat),
                    lng: parseFloat(s.geo_long),
                    name: s.name,
                    url: s.url_resolved
                }));
                world.pointsData(gData);
            })
            .catch(err => {
                console.error(err);
                loader.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
            });

        function playStation(station) {
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
            world.controls().autoRotate = false;

            stationName.innerText = "üì° " + station.name;
            audioPlayer.src = station.url;
            playerCard.style.display = 'block';
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å
            const playPromise = audioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    stationName.innerText = "–ù–∞–∂–º–∏—Ç–µ Play ‚ñ∂Ô∏è " + station.name;
                });
            }
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã Telegram
        if (tg.themeParams.bg_color) {
            document.body.style.backgroundColor = tg.themeParams.bg_color;
            playerCard.style.backgroundColor = tg.themeParams.secondary_bg_color || 'rgba(28, 28, 28, 0.9)';
            document.body.style.color = tg.themeParams.text_color;
        }
    </script>
</body>
</html>
