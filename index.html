<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        /* –°–∏–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä */
        .cluster-marker {
            width: 32px; height: 32px; border: 2px solid #007bff; border-radius: 50%;
            background: rgba(0, 123, 255, 0.3); display: flex; align-items: center;
            justify-content: center; font-size: 11px; font-weight: bold; color: #fff;
            cursor: pointer; pointer-events: auto; transform: translate(-50%, -50%);
        }

        /* –ó–µ–ª–µ–Ω–∞—è —Ç–æ—á–∫–∞ –≥–æ—Ä–æ–¥–∞ */
        .station-dot {
            width: 10px; height: 10px; background: #00ff88; border-radius: 50%;
            border: 1.5px solid #000; cursor: pointer; pointer-events: auto; transform: translate(-50%, -50%);
        }
        .station-dot.active { background: #ffa500; box-shadow: 0 0 10px #ffa500; border-color: #fff; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .pointer { pointer-events: auto; }

        #top-info { position: absolute; top: 0; width: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 15px; text-align: center; display: none; }
        #city-title { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        #station-title { font-size: 16px; font-weight: bold; color: #ffa500; margin-top: 4px; }

        #side-panel { 
            position: absolute; top: 0; left: -300px; width: 280px; height: 100%; 
            background: rgba(10,10,10,0.95); border-right: 1px solid #333; 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        }
        #side-panel.open { left: 0; }
        #station-list { flex: 1; overflow-y: auto; padding: 10px; padding-top: 60px; }
        .list-item { padding: 12px; border-bottom: 1px solid #222; font-size: 13px; cursor: pointer; color: #ccc; }
        .list-item:active { background: #222; }

        #bottom-player { 
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); 
            width: 85%; background: #111; border: 1px solid #333; padding: 15px; 
            border-radius: 20px; display: none; align-items: center; gap: 10px;
        }
        input[type=range] { flex: 1; accent-color: #ffa500; }

        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff88; font-size: 12px; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loader">–ó–ê–ì–†–£–ó–ö–ê –≠–§–ò–†–ê...</div>

    <div id="ui-layer">
        <div id="top-info">
            <div id="city-title">–ì–û–†–û–î</div>
            <div id="station-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏</div>
        </div>

        <div id="side-panel">
            <div id="station-list"></div>
        </div>

        <div class="pointer" style="position:absolute; top:15px; left:15px;" onclick="toggleMenu()">
            <div style="background:#222; padding:10px; border-radius:10px; border:1px solid #444;">‚ò∞</div>
        </div>

        <div id="bottom-player" class="pointer">
            <span id="vol-icon">üîà</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8">
            <span id="time" style="font-family:monospace; font-size:12px;">00:00</span>
        </div>
    </div>

    <div id="globeViz"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        let rawStations = []; // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        let activeStationId = null;
        const audio = new Audio();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±—É—Å–∞
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            .atmosphereColor('#1e4f8a')
            .atmosphereAltitude(0.15)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                if (d.isCluster) {
                    el.className = 'cluster-marker';
                    el.innerHTML = d.count;
                    el.onclick = () => {
                        const currentAlt = world.pointOfView().alt;
                        world.pointOfView({ lat: d.lat, lng: d.lng, alt: currentAlt * 0.4 }, 1000);
                        setTimeout(refreshData, 1100);
                    };
                } else {
                    el.className = 'station-dot';
                    if (activeStationId === d.id) el.classList.add('active');
                    el.onclick = () => loadCityStations(d);
                }
                return el;
            });

        // 1. –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–ú–∏—Ä–æ–≤—ã–µ –¢–û–ü—ã)
        async function init() {
            try {
                const res = await fetch('https://de1.api.radio-browser.info/json/stations/search?limit=600&has_geo_info=true&hidebroken=true&order=clickcount&reverse=true');
                rawStations = await res.json();
                processClusters();
                document.getElementById('loader').style.display = 'none';
            } catch (e) { console.error("API Error"); }
        }

        // 2. –õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Å–ª–∏—è–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤
        function processClusters() {
            const { alt } = world.pointOfView();
            const clusters = {};
            // –ï—Å–ª–∏ –∑—É–º —Å–∏–ª—å–Ω—ã–π, "—Å–µ—Ç–∫–∞" —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–ª—å—á–µ
            const cellSize = alt * 12; 

            rawStations.forEach(s => {
                // –°–ª–∏—è–Ω–∏–µ: –ú–æ—Å–∫–≤–∞ –∏ Moscow –±—É–¥—É—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω –∫–ª—é—á –∑–∞ —Å—á–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const latGrid = Math.round(s.geo_lat / cellSize) * cellSize;
                const lngGrid = Math.round(s.geo_long / cellSize) * cellSize;
                const key = `${latGrid.toFixed(1)}_${lngGrid.toFixed(1)}`;

                if (!clusters[key]) {
                    clusters[key] = { 
                        lat: s.geo_lat, lng: s.geo_long, 
                        count: 0, 
                        isCluster: false,
                        id: s.stationuuid,
                        name: s.name,
                        city: s.state || s.country
                    };
                }
                clusters[key].count++;
            });

            const data = Object.values(clusters).map(c => {
                if (c.count > 1 && alt > 0.6) { // –ù–∞ –≤—ã—Å–æ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
                    c.isCluster = true;
                }
                return c;
            });

            world.htmlElementsData(data);
        }

        // 3. –ü–æ–¥–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π –ø—Ä–∏ –∑—É–º–µ
        async function refreshData() {
            const { lat, lng, alt } = world.pointOfView();
            if (alt > 0.8) return;

            const radius = Math.max(10, alt * 100); // –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã
            const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=300&hidebroken=true`);
            const newStations = await res.json();
            
            // –°–ª–∏—è–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            const ids = new Set(rawStations.map(s => s.stationuuid));
            newStations.forEach(s => {
                if (!ids.has(s.stationuuid)) rawStations.push(s);
            });
            processClusters();
        }

        // 4. –ì–ª—É–±–æ–∫–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–∞ (–ú–æ—Å–∫–≤–∞ –∏ —Ç.–¥.)
        async function loadCityStations(point) {
            // –ü—Ä–∏–±–ª–∏–∂–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
            world.pointOfView({ lat: point.lat, lng: point.lng, alt: 0.3 }, 800);
            world.globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg'); // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É –Ω–∞ —Å–≤–µ—Ç–ª—É—é –ø—Ä–∏ –∑—É–º–µ

            const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${point.lat}&lon=${point.lng}&radius=0.7&limit=400&hidebroken=true`);
            const cityData = await res.json();
            
            const list = document.getElementById('station-list');
            list.innerHTML = `<div style="padding:15px; color:#00ff88; font-weight:bold;">${point.city} (${cityData.length})</div>`;
            
            cityData.sort((a,b) => b.clickcount - a.clickcount).forEach(s => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerText = s.name;
                el.onclick = () => playStation(s, point.city);
                list.appendChild(el);
            });

            document.getElementById('side-panel').classList.add('open');
        }

        function playStation(s, cityName) {
            activeStationId = s.stationuuid;
            document.getElementById('top-info').style.display = 'block';
            document.getElementById('bottom-player').style.display = 'flex';
            document.getElementById('city-title').innerText = cityName;
            document.getElementById('station-title').innerText = s.name;

            audio.src = s.url_resolved.replace('http://', 'https://');
            audio.play().catch(() => alert("–ü–æ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"));
            
            processClusters(); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ä–∞–Ω–∂–µ–≤—É—é —Ç–æ—á–∫—É
        }

        // –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function toggleMenu() { document.getElementById('side-panel').classList.toggle('open'); }
        
        world.controls().addEventListener('change', () => {
            // –ï—Å–ª–∏ —é–∑–µ—Ä —Å–∏–ª—å–Ω–æ –æ—Ç–¥–∞–ª–∏–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—á–Ω—É—é –∫–∞—Ä—Ç—É
            if (world.pointOfView().alt > 1) {
                world.globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg');
            }
        });

        document.getElementById('volume').oninput = (e) => audio.volume = e.target.value;
        audio.ontimeupdate = () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('time').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        init();
    </script>
</body>
</html>
